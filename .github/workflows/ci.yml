name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  rust:
    name: Rust
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build --verbose

  python:
    name: Python
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Build extension
        run: uv run maturin develop --release

      - name: Check formatting (black)
        run: uv run black --check fast_langgraph/ tests/

      - name: Lint (ruff)
        run: uv run ruff check fast_langgraph/ tests/

      - name: Run tests
        run: uv run pytest tests/ -v

  trigger-publish:
    name: Trigger publish workflow
    runs-on: ubuntu-latest
    needs: [rust, python]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      actions: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Cargo version change
        id: cargo_version
        env:
          BEFORE_SHA: ${{ github.event.before }}
        run: |
          CURRENT_VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n 1)
          if [ -z "$CURRENT_VERSION" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BEFORE_REF="${BEFORE_SHA}"
          if [ -z "$BEFORE_REF" ] || ! git cat-file -e "${BEFORE_REF}^{commit}" 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! git show "${BEFORE_REF}:Cargo.toml" > /tmp/previous_cargo.toml 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PREVIOUS_VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' /tmp/previous_cargo.toml | head -n 1)
          if [ -z "$PREVIOUS_VERSION" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$PREVIOUS_VERSION" != "$CURRENT_VERSION" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "previous=$PREVIOUS_VERSION" >> "$GITHUB_OUTPUT"
            echo "current=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger publish workflow
        if: steps.cargo_version.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          PREVIOUS_VERSION: ${{ steps.cargo_version.outputs.previous }}
          CURRENT_VERSION: ${{ steps.cargo_version.outputs.current }}
        run: |
          echo "Cargo.toml version changed from ${PREVIOUS_VERSION} to ${CURRENT_VERSION}. Triggering publish workflow."
          cat > body.json <<EOF
{"ref":"$REF_NAME","inputs":{"publish_to_pypi":"true"}}
EOF
          curl -sSf -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$REPO/actions/workflows/publish.yml/dispatches \
            -d @body.json
